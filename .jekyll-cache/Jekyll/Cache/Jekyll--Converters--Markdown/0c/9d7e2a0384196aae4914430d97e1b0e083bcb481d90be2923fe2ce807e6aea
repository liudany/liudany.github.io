I"'{<p>A reading notes of fairseq <a href="https://fairseq.readthedocs.io/en/latest/">document</a> and <a href="https://github.com/pytorch/fairseq">github page</a>.</p>

<h1 id="overview">Overview</h1>

<h2 id="command-line">Command-Line</h2>

<p>æµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>

<ol>
  <li><code class="highlighter-rouge">fairseq-preprocess</code>æ¥é¢„å¤„ç†æ•°æ®ï¼Œç”¨æ¥å»ºç«‹è¯è¡¨ï¼Œå¹¶ç”Ÿæˆè®­ç»ƒä½¿ç”¨çš„äºŒè¿›åˆ¶æ•°æ®ã€‚</li>
  <li><code class="highlighter-rouge">fairseq-train</code>æ¥è®­ç»ƒæ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨å…¨éƒ¨GPUï¼Œä½¿ç”¨<code class="highlighter-rouge">CUDA_VISIBLE_DEVICES</code>æ¥è°ƒæ•´ç¨‹åºå¯è§çš„GPUæ•°ç›®ï¼Œâš ï¸æ³¨æ„batch_sizeçš„è®¾å®šæ˜¯æ ¹æ®tokensæ¥çš„ï¼Œå‚æ•°<code class="highlighter-rouge">max-tokens</code>ç”¨äºæŒ‡å®šbatchä¸­æœ€å¤§tokenæ•°ã€‚</li>
  <li>è®­ç»ƒå®Œåï¼Œç”¨<code class="highlighter-rouge">fairseq-generate</code>åœ¨äºŒè¿›åˆ¶æ•°æ®ä¸Šè¿›è¡Œæµ‹è¯•ï¼Œraw textåˆ™éœ€è¦ä½¿ç”¨<code class="highlighter-rouge">fairseq-interactive</code>ã€‚å…¶ä¸­ç»§æ‰¿äº†beam-searchçš„æ–¹æ³•ã€‚</li>
</ol>

<h2 id="extend">Extend</h2>

<p>é™¤äº†ä½¿ç”¨ç°æˆçš„æ¨¡å‹å’Œä»»åŠ¡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è‡ªå·±æ‰©å±•äº”ç§ç±»å‹ï¼š</p>

<ul>
  <li>Modelsç”¨äºå®šä¹‰æ¨¡å‹çš„ç»“æ„ï¼ŒåŒ…æ‹¬æ‰€æœ‰éœ€è¦è®­ç»ƒçš„å‚æ•°ã€‚</li>
  <li>Criterionæ¥å®šä¹‰æ–°çš„lossè®¡ç®—æ–¹æ³•ï¼Œæ ¹æ®targetå’Œoutputæ¥ç®—ã€‚</li>
  <li>âš ï¸Tasksç”¨äºä¿å­˜è¯è¡¨ï¼Œæä¾›datasetçš„è¯»å–å’Œè¿­ä»£æ–¹æ³•ï¼Œåˆå§‹åŒ–Modelå’ŒCriterionå¹¶è®¡ç®—Lossã€‚åƒä¸ªæ¡†æ¶ã€‚</li>
  <li>OptimizeræŒ‡å®šå¦‚ä½•æ›´æ–°æ¨¡å‹ä¸­çš„å‚æ•°ã€‚</li>
  <li>Learning Rate Schedulerså®šä¹‰äº†è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ ç‡çš„å˜åŒ–ã€‚</li>
</ul>

<p>æ•´ä¸ªçš„é«˜å±‚å·¥ä½œæµç¨‹ä¸ºï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
    <span class="n">itr</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_batch_iterator</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s">'train'</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">num_updates</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itr</span><span class="p">):</span>
        <span class="n">task</span><span class="o">.</span><span class="n">train_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span> <span class="c1"># åŒ…æ‹¬äº†backward()
</span>        <span class="n">average_and_clip_gradients</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step_update</span><span class="p">(</span><span class="n">num_updates</span><span class="p">)</span>
    <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="register">Register</h2>

<p>æ–°æ¨¡å—åªæœ‰ç»è¿‡æ³¨å†Œä»¥åæ‰èƒ½åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">register_model</span><span class="p">(</span><span class="s">'my_lstm'</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyLSTM</span><span class="p">(</span><span class="n">FairseqModel</span><span class="p">):</span>
    <span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></div>

<p>è‡ªå·±å†™çš„æ¨¡å—ä¹Ÿå¯ä»¥ä¿å­˜åœ¨è‡ªå·±çš„è·¯å¾„ä¸‹é¢ï¼ˆè€Œéæ¡†æ¶é»˜è®¤çš„fairseq/modelä¸‹ï¼‰ï¼Œè¿™ç§æ—¶å€™åœ¨å‘½ä»¤è¡Œä¸­å°±è¦ä½¿ç”¨<code class="highlighter-rouge">--user-dir</code>å‚æ•°æŒ‡å®šcustomæ–‡ä»¶å¤¹ï¼Œ</p>

<h1 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h1>

<p>åšä¸€ä¸ªLSTM encoder-decoderæ¨¡å‹ã€‚</p>

<h2 id="encoderdecoder">Encoder/Decoder</h2>

<p>è¿™ä¸¤éƒ¨åˆ†ç»§æ‰¿<code class="highlighter-rouge">FairseqEncoder/Decoder</code>ï¼ŒåŸºç±»æœ¬èº«ä¹Ÿæ˜¯ç»§æ‰¿è‡ª<code class="highlighter-rouge">nn.Module</code>ï¼Œåªæ˜¯æ™®é€šçš„ä¸¤ä¸ªPyTorchæ¨¡å—ã€‚</p>

<p>æ³¨æ„åˆ°åœ¨initä¸­è¿™ä¿©æ¨¡å—éƒ½ä¼ å…¥äº†dictionaryå‚æ•°ï¼Œå¹¶<code class="highlighter-rouge">super().__init__(dictionary)</code>äº†ä¸€ä¸‹ã€‚æ˜¯ä¸ºäº†è·å–è¯è¡¨é•¿åº¦ï¼Œpadå­—ç¬¦ç­‰ä¿¡æ¯ã€‚</p>

<h2 id="register-the-model">Register the Model</h2>

<p>é€šè¿‡<code class="highlighter-rouge">@register_model('new_model')</code>çš„è£…é¥°æ–¹æ³•æ³¨å†Œæ–°æ¨¡å‹ï¼Œåªæœ‰registerçš„modelæ‰å¯ä»¥ç”¨å‘½ä»¤è¡Œç›´æ¥è°ƒç”¨ã€‚</p>

<p>æ‰€æœ‰Modeléƒ½å¿…é¡»å®ç°<code class="highlighter-rouge">BasicFairseqModel</code>çš„æ‰€æœ‰æ¥å£ï¼Œå¯¹äºSeq2seqä»»åŠ¡æˆ‘ä»¬å¯ä»¥ç»§æ‰¿<code class="highlighter-rouge">FairseqModel</code>ï¼Œå› ä¸ºå®ƒç»§æ‰¿äº†Basicå¹¶é»˜è®¤äº†encoder-decoderç»“æ„ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fairseq.models</span> <span class="kn">import</span> <span class="n">FairseqModel</span><span class="p">,</span> <span class="n">register_model</span>

<span class="o">@</span><span class="n">register_model</span><span class="p">(</span><span class="s">'simple_lstm'</span><span class="p">)</span>	<span class="c1"># å¿…é¡»åœ¨Modelç±»å‰åŠ è£…é¥°
</span><span class="k">class</span> <span class="nc">SimpleLSTMModel</span><span class="p">(</span><span class="n">FairseqModel</span><span class="p">):</span>
  
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">add_args</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>	<span class="c1"># é‡å†™è¿™ä¸ªBasicç±»ä¸­çš„æ¥å£ï¼Œæ·»åŠ å‘½ä»¤è¡Œå‚æ•°
</span>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s">'--encoder-embed-dim'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">'N'</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">'dimensionality of the encoder embeddings'</span><span class="p">,</span>
        <span class="p">)</span>
        
    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>	<span class="c1"># ç”¨äºåˆå§‹åŒ–æ¨¡å‹ï¼Œæ˜¯classmethod
</span>        <span class="n">encoder</span> <span class="o">=</span> <span class="n">SimpleLSTMEncoder</span><span class="p">()</span>	<span class="c1"># çœç•¥å‚æ•°
</span>        <span class="n">decoder</span> <span class="o">=</span> <span class="n">SimpleLSTMDecoder</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SimpleLSTMModel</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">)</span>	<span class="c1"># è¿™é‡Œç”¨äº†SimpleLSTMModelç±»æœ¬èº«
</span>        
        <span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>	<span class="c1"># å¿…é¡»è¿”å›æ¨¡å‹ï¼Œmodelåœ¨build_modelä¸­å®šä¹‰
</span>      
    <span class="c1"># å¯é‡å†™åˆå§‹åŒ–ï¼Œè¿™é‡ŒFairseqModelé»˜è®¤çš„encoder-decoderç»“æ„
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">FairseqEncoder</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span> <span class="n">FairseqDecoder</span><span class="p">)</span>
      
    <span class="c1"># å¯é‡å†™forwardæ–¹æ³•æ¥å†³å®šencoderå’Œdecoderäº¤äº’ç»†èŠ‚ï¼Œä¸‹é¢æ˜¯FairseqModelä¸­defaultçš„åšæ³•
</span>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_lengths</span><span class="p">,</span> <span class="n">prev_output_tokens</span><span class="p">):</span>
        <span class="n">encoder_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">src_tokens</span><span class="p">,</span> <span class="n">src_lengths</span><span class="p">)</span>
        <span class="n">decoder_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">prev_output_tokens</span><span class="p">,</span> <span class="n">encoder_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoder_out</span>
</code></pre></div></div>

<p>âš ï¸è¿™é‡Œçš„build_modelæ˜¯ä¼šåœ¨taskä¸­ä»¥classmethodæ–¹æ³•ç›´æ¥è°ƒç”¨çš„ï¼Œå¯è§†ä¸ºç‹¬ç«‹äºç±»å¤–çš„å‡½æ•°ã€‚</p>

<p>âš ï¸<code class="highlighter-rouge">__init__</code>å‡½æ•°ä¸­superå¿…æœ‰ï¼Œç„¶åæŒ‡å®šforwardä¸­ä¼šç”¨åˆ°çš„ä¸œè¥¿å°±å¯ä»¥ã€‚</p>

<p>âš ï¸forwardçš„è¾“å…¥è¾“å‡ºæ˜¯ç”±taskå†³å®šçš„ï¼Œå…·ä½“æ¥è®²æ˜¯æ¯ä¸ªminibatchä¸­çš„<code class="highlighter-rouge">next_input</code>ã€‚</p>

<h2 id="register-architecture">Register Architecture</h2>

<p>å°†æˆ‘ä»¬çš„æ¨¡å‹èµ·ä¸€ä¸ªarchitectureçš„åå­—ï¼Œå¹¶æ³¨å†Œï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å‘½ä»¤è¡Œé€‰æ‹©<code class="highlighter-rouge">â€”arch</code>å‚æ•°äº†ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fairseq.models</span> <span class="kn">import</span> <span class="n">register_model_architecture</span>

<span class="o">@</span><span class="n">register_model_architecture</span><span class="p">(</span><span class="s">'simple_lstm'</span><span class="p">,</span> <span class="s">'tutorial_simple_lstm'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tutorial_simple_lstm</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>	<span class="c1"># ä¸‹é¢è®¾ç½®äº†é»˜è®¤å‚æ•°ï¼Œå¦‚æœcommandlineæ²¡æŒ‡å®šå°±ç”¨
</span>    <span class="n">args</span><span class="o">.</span><span class="n">encoder_embed_dim</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">'encoder_embed_dim'</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">encoder_hidden_dim</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">'encoder_hidden_dim'</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">decoder_embed_dim</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">'decoder_embed_dim'</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">decoder_hidden_dim</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">'decoder_hidden_dim'</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
</code></pre></div></div>

<p>âš ï¸Architectureå°±æ˜¯å¸¦æœ‰ä¸€ç»„å›ºå®šå‚æ•°çš„modelï¼Œæ˜¯<strong>precise network configuration</strong>ã€‚</p>

<h2 id="register-task">Register Task</h2>

<p>å®˜æ–¹è®²çš„æ˜¯ï¼š</p>

<blockquote>
  <p>A new FairseqTask will load our dictionaries and dataset. Tasks can also control how the data is batched into mini-batches.</p>
</blockquote>

<p>å³taskå†³å®šäº†ä¸€ä¸ªä»»åŠ¡çš„æ•°æ®/è¯å…¸è½½å…¥æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•å°†æ•°æ®åŒ…è£…ä¸ºminibatchçš„å½¢å¼ã€‚å¦‚æœæœ‰æ–°çš„ä»»åŠ¡ï¼Œä¾‹å¦‚åå­—åˆ†ç±»ç­‰ä¸æ˜¯seq2seq/lmçš„ä»»åŠ¡ï¼Œè¦æ³¨å†Œæ–°çš„taskã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">fairseq.data</span> <span class="kn">import</span> <span class="n">Dictionary</span><span class="p">,</span> <span class="n">LanguagePairDataset</span>	<span class="c1"># è¿™é‡Œä¼šç”¨åˆ°è¯­è¨€æ¨¡å‹çš„dataset
</span><span class="kn">from</span> <span class="nn">fairseq.tasks</span> <span class="kn">import</span> <span class="n">FairseqTask</span><span class="p">,</span> <span class="n">register_task</span>


<span class="o">@</span><span class="n">register_task</span><span class="p">(</span><span class="s">'simple_classification'</span><span class="p">)</span>	<span class="c1"># ä¸æ³¨å†Œmodelä¸€æ ·ä¹Ÿè¦ç´§é ç€
</span><span class="k">class</span> <span class="nc">SimpleClassificationTask</span><span class="p">(</span><span class="n">FairseqTask</span><span class="p">):</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">add_args</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>	<span class="c1"># æ·»åŠ ä¸dataç›¸å…³çš„å‚æ•°ï¼Œæœ€å¤§é•¿åº¦ç­‰
</span>        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'data'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">'FILE'</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s">'file prefix for data'</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--max-positions'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s">'max input length'</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">setup_task</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      	<span class="c1"># è¿™é‡Œçš„ä½œç”¨ä¸modelä¸­çš„build_modelç±»ä¼¼ï¼Œè¿”å›ç±»æœ¬èº«ï¼Œå¯è§†ä¸ºç›¸å¯¹ç‹¬ç«‹çš„æ„é€ 
</span>        <span class="n">input_vocab</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">'dict.input.txt'</span><span class="p">))</span>
        <span class="n">label_vocab</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">'dict.label.txt'</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'| [input] dictionary: {} types'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_vocab</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'| [label] dictionary: {} types'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label_vocab</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">SimpleClassificationTask</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">input_vocab</span><span class="p">,</span> <span class="n">label_vocab</span><span class="p">)</span>
		
    <span class="c1">#	è¿™æ˜¯çœŸæ­£çš„æ„é€ å‡½æ•°ï¼Œå³setup_taskçš„è¿”å›å€¼ä¼šè°ƒç”¨çš„å‡½æ•°ï¼Œå…¶ä¸­å®šä¹‰ç±»ä¸­å…¶ä»–å‡½æ•°ä¼šç”¨çš„selfå‚æ•°
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">input_vocab</span><span class="p">,</span> <span class="n">label_vocab</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_vocab</span> <span class="o">=</span> <span class="n">input_vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_vocab</span> <span class="o">=</span> <span class="n">label_vocab</span>
		
    <span class="c1">#	load train/valid/testé›†åˆï¼Œä¼šwarpåœ¨ä¸€ä¸ªforå¾ªç¯ä¸­ï¼Œsplitåˆ†åˆ«æ˜¯t/v/t
</span>    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">'{}.input-label'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">split</span><span class="p">))</span>

        <span class="c1"># Read input sentencesï¼Œè¿”å›ä¸€ä¸ªåä¸ºsentencesçš„listä¿å­˜å„ä¸ªå¥å­
</span>        <span class="n">sentences</span><span class="p">,</span> <span class="n">lengths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">'.input'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
                <span class="n">sentence</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># Tokenize the sentence, splitting on spaces
</span>                <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_vocab</span><span class="o">.</span><span class="n">encode_line</span><span class="p">(</span>
                    <span class="n">sentence</span><span class="p">,</span> <span class="n">add_if_not_exist</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
                <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>

        <span class="c1"># Read labelsï¼Œä¹Ÿæ˜¯ç”¨listä¿å­˜
</span>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">'.label'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="c1"># Convert label to a numeric ID.
</span>                    <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">label_vocab</span><span class="o">.</span><span class="n">add_symbol</span><span class="p">(</span><span class="n">label</span><span class="p">)])</span>
                <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'| {} {} {} examples'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">)))</span>

        <span class="c1"># We reuse LanguagePairDataset since classification can be modeled as a
</span>        <span class="c1"># sequence-to-sequence task where the target sequence has length 1.
</span>        <span class="c1"># å°†ä¸Šé¢çš„source/targetä¸¤ä¸ªlistè¾“å…¥è¿™ä¸ªdatasetç±»ä¸­
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">LanguagePairDataset</span><span class="p">(</span>
            <span class="n">src</span><span class="o">=</span><span class="n">sentences</span><span class="p">,</span>
            <span class="n">src_sizes</span><span class="o">=</span><span class="n">lengths</span><span class="p">,</span>
            <span class="n">src_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_vocab</span><span class="p">,</span>
            <span class="n">tgt</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">tgt_sizes</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)),</span>  <span class="c1"># targets have length 1
</span>            <span class="n">tgt_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_vocab</span><span class="p">,</span>
            <span class="n">left_pad_source</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">max_source_positions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">max_positions</span><span class="p">,</span>
            <span class="n">max_target_positions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="c1"># Since our target is a single class label, there's no need for
</span>            <span class="c1"># input feeding. If we set this to ``True`` then our Model's
</span>            <span class="c1"># ``forward()`` method would receive an additional argument called
</span>            <span class="c1"># *prev_output_tokens* that would contain a shifted version of the
</span>            <span class="c1"># target sequence.
</span>            <span class="n">input_feeding</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">max_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ç›´æ¥è¿”å›ä¸¤ä¸ªæ•°å­—ï¼Œç¬¬ä¸€ä¸ªæ˜¯sourceä¸­æœ€å¤§é•¿åº¦ï¼Œç¬¬äºŒä¸ªæ˜¯labelæœ€å¤§é•¿åº¦
</span>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">max_positions</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">source_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Return the source :class:`~fairseq.data.Dictionary`."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_vocab</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">target_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Return the target :class:`~fairseq.data.Dictionary`."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_vocab</span>
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°taskä¸­è§„å®šäº†å¦‚ä½•ä»æºæ–‡ä»¶è¯»å–æ•°æ®/å­—å…¸ï¼ˆæ³¨æ„å­—å…¸æ˜¯preprocessæ—¶å»ºç«‹å¥½çš„ï¼‰ï¼Œå¹¶é€šè¿‡è¯»å–å¥½çš„listå»ºç«‹datasetç±»ï¼Œç„¶åget_batch_iteratorå‡½æ•°ä»datasetä¸­è·å¾—ä¸€ä¸ªiteratoræ¥è¯»å–æ•°æ®ã€‚</p>

<h2 id="train">Train</h2>

<p>ç°åœ¨å¯ä»¥ç”¨<code class="highlighter-rouge">fairseq-train</code>çš„æ–¹æ³•åœ¨å‘½ä»¤è¡Œé‡Œè®­ç»ƒäº†ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fairseq-train data-bin/iwslt14.tokenized.de-en <span class="se">\</span>
  <span class="nt">--arch</span> tutorial_simple_lstm <span class="se">\</span>
  <span class="nt">--encoder-dropout</span> 0.2 <span class="nt">--decoder-dropout</span> 0.2 <span class="se">\</span>
  <span class="nt">--optimizer</span> adam <span class="nt">--lr</span> 0.005 <span class="nt">--lr-shrink</span> 0.5 <span class="se">\</span>
  <span class="nt">--max-tokens</span> 12000
</code></pre></div></div>

<p>æŒ‡å®šarchå’Œtaskå°±å¯ä»¥äº†ï¼Œè¿™é‡Œtaské»˜è®¤æ˜¯translationï¼Œå³æŒ‰ç…§ç¿»è¯‘ä»»åŠ¡æ¥è¯»å–æ•°æ®ç­‰ã€‚</p>

<h1 id="æ¡†æ¶">æ¡†æ¶</h1>

<p>1âƒ£ï¸åˆå§‹åŒ–GPUå‚æ•°</p>

<p>2âƒ£ï¸task.setup_taskï¼Œå¦‚translation_taskï¼ŒLM taskç­‰ç­‰ã€‚å…¶ä»»åŠ¡æ˜¯æ‰“å¼€æ•°æ®é›†ï¼ŒåŠ è½½è¯è¡¨ï¼Œå¹¶æ‰“å°åˆ°å±å¹•ã€‚</p>

<p>3âƒ£ï¸valid_dataset</p>

<p>4âƒ£ï¸å»ºæ¨¡modelå’Œcriterionï¼Œç›´æ¥è°ƒç”¨task.build_modelï¼Œè¿”å›æˆ‘ä»¬åˆšåˆšå†™çš„build_modelçš„æ¨¡å‹ã€‚build_criterionä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>

<p>5âƒ£ï¸æ‰“å°å‡ºæ¨¡å‹å„ç§ä¿¡æ¯ï¼ˆæ¨¡å‹åå­—è¾“å‡ºçš„æ˜¯archçš„åå­—ï¼‰ã€‚</p>

<p>6âƒ£ï¸buildä¸€ä¸ªtrainerï¼Œè¾“å‡ºäº†ä¸€äº›GPUä¿¡æ¯ã€‚</p>

<p>7âƒ£ï¸å¦‚æœæœ‰é¢„è®­ç»ƒçš„æ¨¡å‹çš„è¯ï¼ŒåŠ è½½è¿›æ¥ã€‚</p>

<p>8âƒ£ï¸åˆå§‹åŒ–å¾ˆå¤šç›¸å…³å‚æ•°ï¼Œmax_epochç­‰ï¼Œé»˜è®¤æœ€å¤§epochæ˜¯æ— ç©·.</p>

<p>9âƒ£ï¸å¼€å§‹è®­ç»ƒï¼æ•´ä¸ªwhileå¾ªç¯çš„æ¡ä»¶æ˜¯lrä¸èƒ½å¤ªå°/epochä¸èƒ½å¤ªå¤§/æ›´æ–°æ¬¡æ•°ä¸èƒ½å¤ªå¤šï¼ˆæ­¥æ•°ï¼‰ã€‚æ¥ä¸‹æ¥å¼€å§‹ä¸€ä¸ªepochçš„å¾ªç¯ï¼Œéƒ½å°è£…åœ¨trainé‡Œé¢äº†ã€‚å…³äºè®­ç»ƒï¼Œtrainå‡½æ•°è°ƒç”¨trainer.train_stepï¼Œè€Œtrainer.train_stepä¸­ä¼šè°ƒç”¨task.train_stepï¼Œè€Œtask.train_stepä¸­æŠŠmodelå’Œsampleé€å…¥fairseq.criterionæ±‚lossã€‚</p>

<p>ğŸ”Ÿè®­ç»ƒä¸€ä¸ªepochï¼ˆtrainå‡½æ•°å®ç°è®­ç»ƒä¸€ä¸ªepochï¼‰ï¼Œæ˜¯validçš„è¯validä¸€ä¸‹ï¼Œæ›´æ–°lrï¼Œä¿å­˜checkpointã€‚æœ€ååœä¸‹æ¥ã€‚</p>

<p>âš ï¸æ‰€æœ‰taskç»§æ‰¿Fairseq_taskå¹¶å®ç°å…¶ä¸­çš„æ¥å£ã€‚</p>

<h1 id="autoencoder">Autoencoder</h1>

<p>é¦–å…ˆï¼Œå¥å­çº§åˆ«çš„autoencoderä¹Ÿæ˜¯ä¸€ä¸ªseq2seqæ¨¡å‹ï¼Œåªä¸è¿‡è¾“å…¥è¾“å‡ºæ˜¯ç›¸åŒçš„ã€‚</p>

<p>æˆ‘ä»¬è¯´AEçš„decoderæ˜¯ä¸€ä¸ªCLMï¼Œé‚£æ‰€æœ‰çš„seq2seqçš„decoderå…¶å®éƒ½æ˜¯CLMï¼Œæ‰€ä»¥æ˜¯åºŸè¯ã€‚</p>
:ET