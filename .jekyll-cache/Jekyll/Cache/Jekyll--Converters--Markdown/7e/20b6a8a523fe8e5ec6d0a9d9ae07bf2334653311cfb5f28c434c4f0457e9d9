I"á†<p>è®°ä¸€ä¸‹é‡å¤å·¥ä½œã€‚</p>

<h2 id="pre-processs">Pre-processs</h2>

<p>è¯­æ–™çš„é¢„å¤„ç†ï¼ŒåŒ…æ‹¬ä¸­æ–‡çš„åˆ†è¯ï¼Œè‹±æ–‡çš„tokenizeï¼Œlowercaseç­‰ã€‚</p>

<p>ä¸­æ–‡éƒ¨åˆ†åŸºäºJiebaï¼Œè‹±æ–‡éƒ¨åˆ†åŸºäºMosesdecoderã€‚</p>

<p>è‹±æ–‡éƒ¨åˆ†ç»è¿‡ä»¥ä¸‹é¢„å¤„ç†ï¼šé¦–å…ˆå°†æ‰€æœ‰å­—ç¬¦è½¬æ¢ä¸ºå°å†™å½¢å¼ï¼Œç„¶åå»é™¤ä¸å¯è¯†åˆ«çš„ç¬¦å·ï¼Œä¹‹åè¿›è¡Œè‹±è¯­çš„tokenizeï¼Œæœ€åå†æ¸…é™¤æ‰é•¿äº250å’ŒçŸ­äº3çš„å¥å­ã€‚ä¸­æ–‡éƒ¨åˆ†åˆ©ç”¨Jiebaåˆ†è¯å¯¹äºè¯­æ–™è¿›è¡Œå¹¶è¡ŒåŒ–åˆ†è¯å¤„ç†ï¼Œå¯¹åº”çš„æ¸…ç†æ‰è¿‡é•¿å’Œè¿‡çŸ­çš„å¥å­ï¼Œå¹¶æŒ‰ç…§100:1çš„æ¯”ä¾‹åˆ’åˆ†è®­ç»ƒé›†ä¸éªŒè¯é›†ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SCRIPTS</span><span class="o">=</span>/home/dyliu/fairseq/examples/translation/mosesdecoder/scripts
<span class="nv">BPEROOT</span><span class="o">=</span>/data/dyliu/fairseq/examples/translation/subword-nmt
<span class="nv">JIEBA</span><span class="o">=</span>/data/dyliu/jieba/test/parallel

<span class="nv">TOKENIZER</span><span class="o">=</span><span class="nv">$SCRIPTS</span>/tokenizer/tokenizer.perl
<span class="nv">LC</span><span class="o">=</span><span class="nv">$SCRIPTS</span>/tokenizer/lowercase.perl
<span class="nv">CLEAN</span><span class="o">=</span><span class="nv">$SCRIPTS</span>/training/clean-corpus-n.perl
<span class="nv">NORM_PUNC</span><span class="o">=</span><span class="nv">$SCRIPTS</span>/tokenizer/normalize-punctuation.perl
<span class="nv">REM_NON_PRINT_CHAR</span><span class="o">=</span><span class="nv">$SCRIPTS</span>/tokenizer/remove-non-printing-char.perl

<span class="nv">src</span><span class="o">=</span>en
<span class="nv">tgt</span><span class="o">=</span>zh
<span class="nv">lang</span><span class="o">=</span>en-zh

<span class="nv">OUTDIR</span><span class="o">=</span>ccmt2019
<span class="nv">prep</span><span class="o">=</span><span class="nv">$OUTDIR</span>
<span class="nv">tmp</span><span class="o">=</span><span class="nv">$prep</span>/tmp

<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$tmp</span> <span class="nv">$prep</span>

<span class="nv">file</span><span class="o">=</span>input

<span class="nb">echo</span> <span class="s2">"pre-processing English data..."</span>
<span class="nb">cat</span> <span class="nv">$file</span>.<span class="nv">$src</span> | <span class="se">\</span>
	perl <span class="nv">$LC</span> | <span class="se">\</span>
	perl <span class="nv">$NORM_PUNC</span> en | <span class="se">\</span>
	perl <span class="nv">$REM_NON_PRINT_CHAR</span> | <span class="se">\</span>
	perl <span class="nv">$TOKENIZER</span> <span class="nt">-threads</span> 8 <span class="nt">-a</span> <span class="nt">-l</span> en <span class="o">&gt;&gt;</span> <span class="nv">$tmp</span>/train.tags.<span class="nv">$lang</span>.tok.<span class="nv">$src</span>


<span class="nb">echo</span> <span class="s2">"pre-processing Chinese data..."</span>

python <span class="nv">$JIEBA</span>/test_file.py ./<span class="nv">$file</span>.<span class="nv">$tgt</span> 

<span class="nb">mv</span> ./train.tags.en-zh.tok.zh <span class="nv">$tmp</span>/

<span class="nb">echo</span> <span class="s2">"splitting train and valid..."</span>
<span class="k">for </span>l <span class="k">in</span> <span class="nv">$src</span> <span class="nv">$tgt</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">awk</span> <span class="s1">'{if (NR%100 == 0)  print $0; }'</span> <span class="nv">$tmp</span>/train.tags.<span class="nv">$lang</span>.tok.<span class="nv">$l</span> <span class="o">&gt;</span> <span class="nv">$tmp</span>/valid.<span class="nv">$l</span>
    <span class="nb">awk</span> <span class="s1">'{if (NR%100 != 0)  print $0; }'</span> <span class="nv">$tmp</span>/train.tags.<span class="nv">$lang</span>.tok.<span class="nv">$l</span> <span class="o">&gt;</span> <span class="nv">$tmp</span>/train.<span class="nv">$l</span>
<span class="k">done</span>

<span class="c">#echo "learn_bpe.py on ${file}..."</span>
<span class="c">#BPE_TOKENS=40000</span>
<span class="c">#BPR_CODE=./code</span>
<span class="c">#python $BPEROOT/learn_bpe.py -s $BPE_TOKENS &lt; $file &gt; $BPE_CODE</span>

<span class="c">#echo "apply_bpe.py to ${file}..."</span>
<span class="c">#python $BPEROOT/apply_bpe.py -c $BPE_CODE &lt; $file &gt; bpe.$file</span>


<span class="nb">echo</span> <span class="s2">"cleaning data..."</span>
perl <span class="nv">$CLEAN</span> <span class="nt">-ratio</span> 1.5 <span class="nv">$tmp</span>/train <span class="nv">$src</span> <span class="nv">$tgt</span> <span class="nv">$prep</span>/train 1 250
perl <span class="nv">$CLEAN</span> <span class="nt">-ratio</span> 1.5 <span class="nv">$tmp</span>/valid <span class="nv">$src</span> <span class="nv">$tgt</span> <span class="nv">$prep</span>/valid 1 250
</code></pre></div></div>

<p>âš ï¸è¿™é‡Œä¸ç¡®å®šBPEå¯¹ä¸­è‹±ç¿»è¯‘æ˜¯å¦æœ‰æ•ˆï¼Œå…ˆæ³¨é‡Šæ‰åé¢å†è¯•ã€‚</p>

<h2 id="train">Train</h2>

<h3 id="fairseq-preprocess">fairseq-preprocess</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">TEXT</span><span class="o">=</span>/data/dyliu/script/ccmt2019
fairseq-preprocess <span class="nt">--source-lang</span> en <span class="nt">--target-lang</span> zh <span class="se">\</span>
    <span class="nt">--trainpref</span> <span class="nv">$TEXT</span>/train <span class="nt">--validpref</span> <span class="nv">$TEXT</span>/valid <span class="se">\</span>
    <span class="nt">--destdir</span> data-bin/ccmt2019 <span class="nt">--nwordstgt</span> 50000 <span class="nt">--nwordssrc</span> 50000
</code></pre></div></div>

<p>è¿™ä¸€æ­¥å»ºç«‹è¯è¡¨å¹¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ä»¥å¤‡åé¢è®­ç»ƒã€‚</p>

<h3 id="fairseq-train">fairseq-train</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">checkpoints</span><span class="o">/</span><span class="n">fconv</span><span class="o">-</span><span class="n">ccmt</span><span class="o">-</span><span class="n">test</span>
<span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="mi">3</span> <span class="n">fairseq</span><span class="o">-</span><span class="n">train</span> <span class="n">data</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">ccmt2019</span> \
    <span class="o">--</span><span class="n">lr</span> <span class="mf">0.25</span> <span class="o">--</span><span class="n">clip</span><span class="o">-</span><span class="n">norm</span> <span class="mf">0.1</span> <span class="o">--</span><span class="n">dropout</span> <span class="mf">0.2</span> <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">tokens</span> <span class="mi">4000</span> \
    <span class="o">--</span><span class="n">arch</span> <span class="n">transformer</span> <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="nb">dir</span> <span class="n">checkpoints</span><span class="o">/</span><span class="n">fconv</span><span class="o">-</span><span class="n">ccmt</span><span class="o">-</span><span class="n">test</span>
</code></pre></div></div>

<p>é»˜è®¤ä½¿ç”¨å…¨éƒ¨GPUï¼Œæ‰€ä»¥è®¾ç½®å¯è§GPUçš„æ•°ç›®ã€‚</p>

<p>âš ï¸æ³¨æ„è¿™é‡Œä»¥max-tokensçš„å½¢å¼ç¡®å®šbatchçš„å¤§å°ã€‚</p>

<h2 id="ç»“æœè®°å½•">ç»“æœè®°å½•</h2>

<h3 id="fconv-casia2015">fconv casia2015</h3>

<p>å½“å‰è¯è¡¨é˜ˆå€¼è®¾ç½®ä¸º0ï¼Œé¢„å¤„ç†çš„è‹±æ–‡è¯è¡¨30w+ï¼Œä¸­æ–‡20w+ã€‚æ¨¡å‹å‚æ•°265809872ã€‚</p>

<p>fconvæ¡†æ¶ä¸‹å‡ºç°</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| WARNING: ran out of memory with exception: CUDA out of memory. Tried to allocate 4.37 GiB <span class="o">(</span>GPU 0<span class="p">;</span> 10.92 GiB total capacity<span class="p">;</span> 4.59 GiB already allocated<span class="p">;</span> 1.52 GiB free<span class="p">;</span> 4.18 GiB cached<span class="o">)</span><span class="p">;</span>
 Skipping batch
| WARNING: OOM <span class="k">in </span>all workers, skipping update
</code></pre></div></div>

<p>æ”¹å˜è¯è¡¨è¯•ä¸€ä¸‹ï¼Œpreprocessé‡Œé¢ç”¨<code class="highlighter-rouge">--thresholdtgt</code> å’Œ<code class="highlighter-rouge">--thresholdsrc</code>å‚æ•°ï¼Œè®¾ç½®ä¸ª2è¯•è¯•ã€‚</p>

<p>è®¾ç½®ä¸º2çš„æ—¶å€™ï¼Œenè¯­æ–™æ¸…æ´—0.5%å·¦å³ï¼Œ10Wè¯è¡¨ã€‚zh17Wè¯è¡¨ï¼Œ1%å·¦å³è¢«æ›¿æ¢ã€‚</p>

<p>è¿˜æ˜¯åŒæ ·çš„é”™è¯¯ã€‚</p>

<p>ä½¿ç”¨<code class="highlighter-rouge">â€”nwordssrc</code>å’Œ<code class="highlighter-rouge">-nwordstgt</code>ç›´æ¥è®¾ç½®è¯è¡¨å¤§å°ã€‚</p>

<p>5Wè¯è¡¨å¤§å°ï¼Œæ›¿æ¢1.18%çš„è‹±æ–‡ã€‚æ›¿æ¢æ‰3.5%çš„ä¸­æ–‡ã€‚å‚æ•°å¤§å°139592864ã€‚</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">vocab_size_en</th>
      <th style="text-align: center">vocab_size_zh</th>
      <th style="text-align: center">threshold</th>
      <th style="text-align: center">Replace(en/zh%)</th>
      <th style="text-align: center">parameters</th>
      <th style="text-align: center">oom</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">300,000</td>
      <td style="text-align: center">200,000</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">265,809,872</td>
      <td style="text-align: center">yes</td>
    </tr>
    <tr>
      <td style="text-align: center">100,000</td>
      <td style="text-align: center">170,000</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">yes</td>
    </tr>
    <tr>
      <td style="text-align: center">50,000</td>
      <td style="text-align: center">50,000</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">1.18/3.5</td>
      <td style="text-align: center">139,592,864</td>
      <td style="text-align: center">no</td>
    </tr>
  </tbody>
</table>

<p>çœ‹äº†å‡ ç¯‡ACLæ–‡ç« ï¼Œéƒ½æ˜¯30kå·¦å³çš„vocabï¼Œè‹±æ–‡è¦†ç›–ç‡æ™®éæ¯”è¾ƒé«˜ï¼Œ99%ä»¥ä¸Šï¼Œä¸­æ–‡åœ¨97%ä»¥ä¸Šã€‚</p>

<h3 id="transformer">Transformer</h3>

<p>å…ˆè·‘iwslt14 de-enè¯•è¯•ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="mi">1</span> <span class="n">fairseq</span><span class="o">-</span><span class="n">train</span> <span class="n">data</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">iwslt14</span><span class="o">.</span><span class="n">tokenized</span><span class="o">.</span><span class="n">de</span><span class="o">-</span><span class="n">en</span> \
  <span class="o">-</span><span class="n">a</span> <span class="n">transformer_iwslt_de_en</span> <span class="o">--</span><span class="n">optimizer</span> <span class="n">adam</span> <span class="o">--</span><span class="n">lr</span> <span class="mf">0.0005</span> <span class="o">-</span><span class="n">s</span> <span class="n">de</span> <span class="o">-</span><span class="n">t</span> <span class="n">en</span> \
  <span class="o">--</span><span class="n">label</span><span class="o">-</span><span class="n">smoothing</span> <span class="mf">0.1</span> <span class="o">--</span><span class="n">dropout</span> <span class="mf">0.3</span> <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">tokens</span> <span class="mi">4000</span> \
  <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">lr</span> <span class="s">'1e-09'</span> <span class="o">--</span><span class="n">lr</span><span class="o">-</span><span class="n">scheduler</span> <span class="n">inverse_sqrt</span> <span class="o">--</span><span class="n">weight</span><span class="o">-</span><span class="n">decay</span> <span class="mf">0.0001</span> \
  <span class="o">--</span><span class="n">criterion</span> <span class="n">label_smoothed_cross_entropy</span> <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">update</span> <span class="mi">50000</span> \
  <span class="o">--</span><span class="n">warmup</span><span class="o">-</span><span class="n">updates</span> <span class="mi">4000</span> <span class="o">--</span><span class="n">warmup</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lr</span> <span class="s">'1e-07'</span> \
  <span class="o">--</span><span class="n">adam</span><span class="o">-</span><span class="n">betas</span> <span class="s">'(0.9, 0.98)'</span> <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="nb">dir</span> <span class="n">checkpoints</span><span class="o">/</span><span class="n">transformer</span>
</code></pre></div></div>

<p>æŠ¥é”™ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TypeError: Class advice impossible <span class="k">in </span>Python3.  Use the @implementer class decorator instead.
</code></pre></div></div>

<p>å…ˆå°è¯•æ›´æ–°pytorchç‰ˆæœ¬ï¼Œ0.4-&gt;1.0ï¼Œè§£å†³äº†ã€‚</p>

<p>å¤„ç†è¯­æ–™ï¼Œåˆå¹¶æ‰€æœ‰æä¾›çš„è¯­æ–™å¹¶è·‘é¢„å¤„ç†è„šæœ¬ã€‚</p>

<p>å…ˆé¢„å¤„ç†</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">TEXT</span><span class="o">=</span>/data/dyliu/script/ccmt2019
fairseq-preprocess <span class="nt">--source-lang</span> en <span class="nt">--target-lang</span> zh <span class="se">\</span>
    <span class="nt">--trainpref</span> <span class="nv">$TEXT</span>/train <span class="nt">--validpref</span> <span class="nv">$TEXT</span>/valid <span class="se">\</span>
    <span class="nt">--destdir</span> data-bin/ccmt2019 <span class="nt">--nwordstgt</span> 50000 <span class="nt">--nwordssrc</span> 50000
</code></pre></div></div>

<p>åœ¨4å¡ä¸Šï¼Œç»¼åˆè¯­æ–™ä¸Šï¼Œ600W+ï¼Œè·‘5Wçš„è¯è¡¨ï¼Œè·‘en-zhã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span>0 fairseq-train data-bin/ccmt2019 <span class="se">\</span>
  <span class="nt">-a</span> transformer <span class="nt">--optimizer</span> adam <span class="nt">--lr</span> 0.0005 <span class="nt">-s</span> en <span class="nt">-t</span> zh <span class="se">\</span>
  <span class="nt">--label-smoothing</span> 0.1 <span class="nt">--dropout</span> 0.3 <span class="nt">--max-tokens</span> 4000 <span class="se">\</span>
  <span class="nt">--min-lr</span> <span class="s1">'1e-09'</span> <span class="nt">--lr-scheduler</span> inverse_sqrt <span class="nt">--weight-decay</span> 0.0001 <span class="se">\</span>
  <span class="nt">--criterion</span> label_smoothed_cross_entropy <span class="nt">--max-update</span> 50000 <span class="se">\</span>
  <span class="nt">--warmup-updates</span> 4000 <span class="nt">--warmup-init-lr</span> <span class="s1">'1e-07'</span> <span class="se">\</span>
  <span class="nt">--adam-betas</span> <span class="s1">'(0.9, 0.98)'</span> <span class="nt">--save-dir</span> checkpoints/transformer-en-zh
</code></pre></div></div>

<p>è·‘å®Œäº†ï¼Œè¿™ä¸ªæ¡ä»¶æ˜¯50000æ­¥ï¼Œä¸çŸ¥é“ä¼šä¸ä¼šæœ‰é—®é¢˜ã€‚</p>

<p>ä¸‹é¢æµ‹è¯•ã€‚è¦å¤„ç†xmlæ ¼å¼æ•°æ®ã€‚</p>

<p>å…ˆè¯•è¯•interactiveï¼Œé¦–å…ˆè¦æŒ‡å®šæ¨¡å‹å’Œæ–‡ä»¶å¤¹ï¼Œä¸‹é¢æœ‰è¯­è¨€ï¼Œè¦æ˜¾ç¤ºè§„å®šè¯­è¨€å¯¹</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fairseq-interactive data-bin/ccmt2019/ <span class="nt">--path</span> checkpoints/transformer/checkpoint_best.pt <span class="se">\</span>
	 		<span class="nt">-s</span> en <span class="nt">-t</span> zh
</code></pre></div></div>

<p>æ€»å…±éœ€è¦4ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å­—å…¸å­˜åœ¨çš„æ–‡ä»¶å¤¹ï¼Œç¬¬äºŒä¸ªæ˜¯éœ€è¦çš„checkpointï¼Œæ¥ä¸‹æ¥æ˜¯æŒ‡å®šçš„è¯­è¨€æ‰©å±•åï¼Œç”¨äºæ‰¾è¯å…¸ã€‚</p>

<p>äº¤äº’å¼çš„æ–¹æ³•è¦æ³¨æ„äººå·¥æ·»åŠ BPEæ ‡å¿—ï¼Œäººå·¥</p>

<p>åœ¨8å¡ä¸Šï¼ŒåŒæ ·çš„é¢„æ–™ï¼Œæ³¡ä¸ªfcovã€‚æ³¨æ„åˆ‡åˆ°fairseqç¯å¢ƒä¸‹ï¼Œsource activate fairseqã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span>3 fairseq-train data-bin/ccmt2019 <span class="se">\</span>
    <span class="nt">--lr</span> 0.25 <span class="nt">--clip-norm</span> 0.1 <span class="nt">--dropout</span> 0.2 <span class="nt">--max-tokens</span> 4000 <span class="se">\</span>
    <span class="nt">--arch</span> fconv <span class="nt">--save-dir</span> checkpoints/fconv-ccmt2019
</code></pre></div></div>

<p>å‚æ•°139592864ã€‚è¯è¡¨ä¸€æ ·å¤§æ— æ‰€è°“è¯­è¨€ï¼Ÿ</p>

<h2 id="æ–‡ä»¶å¤„ç†">æ–‡ä»¶å¤„ç†</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep </span>pattern file
<span class="nb">grep</span> <span class="s1">'&lt;seg id'</span> filename
</code></pre></div></div>

<p>æ–‡æœ¬æœç´¢å‘½ä»¤ï¼Œè¿”å›çš„æ˜¯ç¬¦åˆçš„è¡Œã€‚</p>

<p>sedå‘½ä»¤ä¸€æ¬¡å¤„ç†ä¸€è¡Œï¼Œ</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sed</span> <span class="o">[</span><span class="nt">-nefri</span><span class="o">]</span> <span class="o">[</span>åŠ¨ä½œ]
</code></pre></div></div>

<p>å‚æ•°æ–¹é¢ä¸€èˆ¬æŒ‡å®šeï¼Œnæ˜¯silentæ¨¡å¼ï¼Œfç›´æ¥å†™åœ¨æ–‡ä»¶é‡Œï¼Œiç›´æ¥æ”¹å˜æ–‡ä»¶</p>

<p>åŠ¨ä½œæ˜¯[n1, n2] functionï¼Œå‰ä¸¤ä¸ªæ•°å­—æŒ‡å®šè¡Œæ•°ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sed</span> <span class="s2">"s/my/ldy's/g"</span> test.txt
</code></pre></div></div>

<p>sæ˜¯æ›¿ä»£ï¼Œmyæ˜¯åŒ¹é…çš„ï¼Œldyâ€™sæ˜¯æ›¿æ¢æˆçš„ï¼Œgæ˜¯æ¯ä¸€è¡Œæ‰€æœ‰åŒ¹é…</p>

<p>sedå‘½ä»¤æ²¡æœ‰æ”¹å†™ï¼Œé™¤é -i ç›´æ¥æ”¹å˜æ–‡ä»¶ï¼Œæˆ–è€… &gt;</p>

<p>-e æ˜¯å¤šä¸ªåŒ¹é…æ—¶ç”¨ã€‚</p>

<p>åœ¨æ¯è¡Œçš„å¤´æ·»åŠ å­—ç¬¦ï¼Œæ¯”å¦‚â€HEADâ€ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<p>sed â€˜s/^/HEAD&amp;/gâ€™ test.file</p>

<p>åœ¨æ¯è¡Œçš„è¡Œå°¾æ·»åŠ å­—ç¬¦ï¼Œæ¯”å¦‚â€œTAILâ€ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>

<p>sed â€˜s/$/&amp;TAIL/gâ€™ test.file</p>

<p>å…·ä½“æ¥è®²å¤„ç†xmlæ–‡ä»¶ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nb">grep</span> <span class="s1">'&lt;seg id'</span> <span class="nv">$orig</span>/test-full/newstest2014-fren-<span class="nv">$t</span>.<span class="nv">$l</span>.sgm | <span class="se">\</span>
        <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/&lt;seg id="[0-9]*"&gt;\s*//g'</span> | <span class="se">\</span>
        <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/\s*&lt;\/seg&gt;\s*//g'</span> | <span class="se">\</span>
        <span class="nb">sed</span> <span class="nt">-e</span> <span class="s2">"s/</span><span class="se">\â€™</span><span class="s2">/</span><span class="se">\'</span><span class="s2">/g"</span> | <span class="se">\</span>
    perl <span class="nv">$TOKENIZER</span> <span class="nt">-threads</span> 8 <span class="nt">-a</span> <span class="nt">-l</span> <span class="nv">$l</span> <span class="o">&gt;</span> <span class="nv">$tmp</span>/test.<span class="nv">$l</span>
</code></pre></div></div>

<h2 id="ç°åœ¨æ¥generate">ç°åœ¨æ¥generate</h2>

<p>ç°åœ¨preprocesså®ƒ</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fairseq-preprocess <span class="nt">--source-lang</span> en <span class="nt">--target-lang</span> zh <span class="se">\</span>
    <span class="nt">--testpref</span> <span class="nb">test</span><span class="se">\</span>
    <span class="nt">--destdir</span> data-bin/ccmt2019 <span class="nt">--srcdict</span> data-bin/ccmt2019/dict.en.txt<span class="se">\</span>
    <span class="nt">--tgtdict</span> data-bin/ccmt2019/dict.zh.txt
</code></pre></div></div>

<p>è¿™æ ·å¯ä»¥åªå¤„ç†testï¼Œæ³¨æ„preprocesså’Œå¾…å¤„ç†çš„æ–‡ä»¶åº”è¯¥åœ¨åŒä¸€ä¸ªè·¯å¾„ä¸‹é¢æ‰§è¡Œã€‚</p>

<p>æŒ‡å®šä¸¤ç§langå¯ä»¥é™åˆ¶åå­—ã€‚</p>

<p>ç„¶ågenerate</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span>3 fairseq-generate data-bin/ccmt2019/ <span class="nt">--path</span> checkpoints/transformer-en-zh-infinite/checkpoint_best.pt <span class="nt">--batch-size</span> 128 <span class="nt">--beam</span> 5 <span class="nt">--source-lang</span> en <span class="nt">--target-lang</span> zh
</code></pre></div></div>

<p>è¯´åå­—ä¸å¯¹ï¼Œtestæ²¡æ‰¾åˆ°ï¼Œè·¯å¾„é—®é¢˜ï¼Œä¸Šé¢preprocessåœ¨å½“å‰è·¯å¾„ä¸‹æ‰§è¡Œã€‚</p>

<p>æ”¹å¥½äº†ã€‚AttributeError: â€˜NoneTypeâ€™ object has no attribute â€˜sizesâ€™ ã€‚</p>

<p>è¿™æ˜¯å› ä¸ºè¦æœ‰å¯¹æ¯”çš„ï¼Œä¼šæœ‰ä¸€ä¸ªh s p å’Œtargetçš„å¯¹æ¯”ï¼Œå³å¿…é¡»è¦æœ‰targetè¯­è¨€ã€‚å³preprocessä¸å¯ä»¥åªæä¾›ä¸€ç§è¯­è¨€ï¼Œä¸å¯ä»¥only-sourceï¼Œåœ¨data-biné‡Œå¿…é¡»è¦targetçš„å†…å®¹ã€‚</p>

<p>æ³¨æ„è¦ä»¥&gt;çš„å½¢å¼è¾“å‡ºåˆ°æ–‡ä»¶ã€‚</p>

<p>ä¹‹åæ­£åˆ™åŒ¹é…æ‰å‰åæ— å…³çš„ä¸œè¥¿ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep</span> <span class="s1">'H'</span> dev.output | <span class="nb">sed</span> <span class="s1">'s/H-[0-9]*\t-[0-9]*.[0-9]*\t//g'</span>|sed <span class="s1">'s/ //g '</span><span class="o">&gt;</span>test.output
</code></pre></div></div>

<p>å°±okäº†ã€‚</p>

<h2 id="å›è¿‡å¤´è°ƒtransformer">å›è¿‡å¤´è°ƒtransformer</h2>

<p>ä¹‹å‰</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span>3 fairseq-train data-bin/ccmt2019 <span class="se">\</span>
  <span class="nt">-a</span> transformer <span class="nt">--optimizer</span> adam <span class="nt">--lr</span> 0.0005 <span class="nt">-s</span> zh <span class="nt">-t</span> en <span class="se">\</span>
  <span class="nt">--label-smoothing</span> 0.1 <span class="nt">--dropout</span> 0.3 <span class="nt">--max-tokens</span> 4000 <span class="se">\</span>
  <span class="nt">--min-lr</span> <span class="s1">'1e-09'</span> <span class="nt">--lr-scheduler</span> inverse_sqrt <span class="nt">--weight-decay</span> 0.0001 <span class="se">\</span>
  <span class="nt">--criterion</span> label_smoothed_cross_entropy <span class="se">\</span>
  <span class="nt">--warmup-updates</span> 4000 <span class="nt">--warmup-init-lr</span> <span class="s1">'1e-07'</span> <span class="se">\</span>
  <span class="nt">--adam-betas</span> <span class="s1">'(0.9, 0.98)'</span> <span class="nt">--save-dir</span> checkpoints/transformer-zh-en
</code></pre></div></div>

<p>æœ‰ä¸‰ç§åœæ­¢æ¡ä»¶ï¼Œmax-epoch max-updateå’Œmin-lrï¼Œé»˜è®¤çš„min_lr 1e-09ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Namespace<span class="o">(</span><span class="nv">activation_dropout</span><span class="o">=</span>0.0, <span class="nv">activation_fn</span><span class="o">=</span><span class="s1">'relu'</span>, <span class="nv">adam_betas</span><span class="o">=</span><span class="s1">'(0.9, 0.98)'</span>, <span class="nv">adam_eps</span><span class="o">=</span>1e-08, <span class="nv">adaptive_input</span><span class="o">=</span>False, <span class="nv">adaptive_softmax_cutoff</span><span class="o">=</span>None, <span class="nv">adaptive_softmax_dropout</span><span class="o">=</span>0, <span class="nb">arch</span><span class="o">=</span><span class="s1">'transformer'</span>, <span class="nv">attention_dropout</span><span class="o">=</span>0.0, <span class="nv">bucket_cap_mb</span><span class="o">=</span>25, <span class="nv">clip_norm</span><span class="o">=</span>25, <span class="nv">cpu</span><span class="o">=</span>False, <span class="nv">criterion</span><span class="o">=</span><span class="s1">'label_smoothed_cross_entropy'</span>, <span class="nv">curriculum</span><span class="o">=</span>0, <span class="nv">data</span><span class="o">=</span><span class="s1">'data-bin/ccmt2019'</span>, <span class="nv">dataset_impl</span><span class="o">=</span><span class="s1">'cached'</span>, <span class="nv">ddp_backend</span><span class="o">=</span><span class="s1">'c10d'</span>, <span class="nv">decoder_attention_heads</span><span class="o">=</span>8, <span class="nv">decoder_embed_dim</span><span class="o">=</span>512, <span class="nv">decoder_embed_path</span><span class="o">=</span>None, <span class="nv">decoder_ffn_embed_dim</span><span class="o">=</span>2048, <span class="nv">decoder_final_norm</span><span class="o">=</span>False, <span class="nv">decoder_input_dim</span><span class="o">=</span>512, <span class="nv">decoder_layers</span><span class="o">=</span>6, <span class="nv">decoder_learned_pos</span><span class="o">=</span>False, <span class="nv">decoder_normalize_before</span><span class="o">=</span>False, <span class="nv">decoder_output_dim</span><span class="o">=</span>512, <span class="nv">device_id</span><span class="o">=</span>0, <span class="nv">disable_validation</span><span class="o">=</span>False, <span class="nv">distributed_backend</span><span class="o">=</span><span class="s1">'nccl'</span>, <span class="nv">distributed_init_method</span><span class="o">=</span>None, <span class="nv">distributed_no_spawn</span><span class="o">=</span>False, <span class="nv">distributed_port</span><span class="o">=</span><span class="nt">-1</span>, <span class="nv">distributed_rank</span><span class="o">=</span>0, <span class="nv">distributed_world_size</span><span class="o">=</span>1, <span class="nv">dropout</span><span class="o">=</span>0.3, <span class="nv">encoder_attention_heads</span><span class="o">=</span>8, <span class="nv">encoder_embed_dim</span><span class="o">=</span>512, <span class="nv">encoder_embed_path</span><span class="o">=</span>None, <span class="nv">encoder_ffn_embed_dim</span><span class="o">=</span>2048, <span class="nv">encoder_layers</span><span class="o">=</span>6, <span class="nv">encoder_learned_pos</span><span class="o">=</span>False, <span class="nv">encoder_normalize_before</span><span class="o">=</span>False, <span class="nv">find_unused_parameters</span><span class="o">=</span>False, <span class="nv">fix_batches_to_gpus</span><span class="o">=</span>False, <span class="nv">fp16</span><span class="o">=</span>False, <span class="nv">fp16_init_scale</span><span class="o">=</span>128, <span class="nv">fp16_scale_tolerance</span><span class="o">=</span>0.0, <span class="nv">fp16_scale_window</span><span class="o">=</span>None, <span class="nv">keep_interval_updates</span><span class="o">=</span><span class="nt">-1</span>, <span class="nv">keep_last_epochs</span><span class="o">=</span><span class="nt">-1</span>, <span class="nv">label_smoothing</span><span class="o">=</span>0.1, <span class="nv">lazy_load</span><span class="o">=</span>False, <span class="nv">left_pad_source</span><span class="o">=</span><span class="s1">'True'</span>, <span class="nv">left_pad_target</span><span class="o">=</span><span class="s1">'False'</span>, <span class="nv">log_format</span><span class="o">=</span>None, <span class="nv">log_interval</span><span class="o">=</span>1000, <span class="nv">lr</span><span class="o">=[</span>0.0005], <span class="nv">lr_scheduler</span><span class="o">=</span><span class="s1">'inverse_sqrt'</span>, <span class="nv">max_epoch</span><span class="o">=</span>0, <span class="nv">max_sentences</span><span class="o">=</span>None, <span class="nv">max_sentences_valid</span><span class="o">=</span>None, <span class="nv">max_source_positions</span><span class="o">=</span>1024, <span class="nv">max_target_positions</span><span class="o">=</span>1024, <span class="nv">max_tokens</span><span class="o">=</span>4000, <span class="nv">max_update</span><span class="o">=</span>0, <span class="nv">memory_efficient_fp16</span><span class="o">=</span>False, <span class="nv">min_loss_scale</span><span class="o">=</span>0.0001, <span class="nv">min_lr</span><span class="o">=</span>1e-09, <span class="nv">no_epoch_checkpoints</span><span class="o">=</span>False, <span class="nv">no_progress_bar</span><span class="o">=</span>False, <span class="nv">no_save</span><span class="o">=</span>False, <span class="nv">no_token_positional_embeddings</span><span class="o">=</span>False, <span class="nv">num_workers</span><span class="o">=</span>0, <span class="nv">optimizer</span><span class="o">=</span><span class="s1">'adam'</span>, <span class="nv">optimizer_overrides</span><span class="o">=</span><span class="s1">'{}'</span>, <span class="nv">raw_text</span><span class="o">=</span>False, <span class="nv">required_batch_size_multiple</span><span class="o">=</span>8, <span class="nv">reset_lr_scheduler</span><span class="o">=</span>False, <span class="nv">reset_meters</span><span class="o">=</span>False, <span class="nv">reset_optimizer</span><span class="o">=</span>False, <span class="nv">restore_file</span><span class="o">=</span><span class="s1">'checkpoint_last.pt'</span>, <span class="nv">save_dir</span><span class="o">=</span><span class="s1">'checkpoints/transformer-en-zh-infinite'</span>, <span class="nv">save_interval</span><span class="o">=</span>1, <span class="nv">save_interval_updates</span><span class="o">=</span>0, <span class="nv">seed</span><span class="o">=</span>1, <span class="nv">sentence_avg</span><span class="o">=</span>False, <span class="nv">share_all_embeddings</span><span class="o">=</span>False, <span class="nv">share_decoder_input_output_embed</span><span class="o">=</span>False, <span class="nv">skip_invalid_size_inputs_valid_test</span><span class="o">=</span>False, <span class="nv">source_lang</span><span class="o">=</span><span class="s1">'en'</span>, <span class="nv">target_lang</span><span class="o">=</span><span class="s1">'zh'</span>, <span class="nv">task</span><span class="o">=</span><span class="s1">'translation'</span>, <span class="nv">tensorboard_logdir</span><span class="o">=</span><span class="s1">''</span>, <span class="nv">threshold_loss_scale</span><span class="o">=</span>None, <span class="nv">train_subset</span><span class="o">=</span><span class="s1">'train'</span>, <span class="nv">update_freq</span><span class="o">=[</span>1], <span class="nv">upsample_primary</span><span class="o">=</span>1, <span class="nv">user_dir</span><span class="o">=</span>None, <span class="nv">valid_subset</span><span class="o">=</span><span class="s1">'valid'</span>, <span class="nv">validate_interval</span><span class="o">=</span>1, <span class="nv">warmup_init_lr</span><span class="o">=</span>1e-07, <span class="nv">warmup_updates</span><span class="o">=</span>4000, <span class="nv">weight_decay</span><span class="o">=</span>0.0001<span class="o">)</span>
| <span class="o">[</span>en] dictionary: 50000 types
| <span class="o">[</span>zh] dictionary: 50000 types
</code></pre></div></div>

<h2 id="tensorboard">tensorboard</h2>

<p>æ€ä¹ˆå¼€è¿™ä¸ªã€‚</p>

<h2 id="ç»“æœè®°å½•-1">ç»“æœè®°å½•</h2>

<p>ç°åœ¨30023 8å¡æœºå™¨åœ¨è·‘çš„æ˜¯fconv-ccmt2019ï¼Œè·‘å®Œäº†ã€‚æµ‹ä¸€ä¸‹</p>

<p>40023 4å¡æœºå™¨åœ¨è·‘çš„æ˜¯transformer-en-zh-infiniteï¼Œè¿™åå­—æ˜¯ä¸€å¼€å§‹æˆ‘ä»¥ä¸ºä¸è®¾ç½®ç»“æŸæ¡ä»¶å°±æ— é™åˆ¶ï¼ˆå…¶å®æœ‰min_lrï¼‰ã€‚</p>

<p>ç°åœ¨é—®é¢˜æ˜¯ç”Ÿæˆçš„å¥å­æ˜¯ä¹±åºçš„</p>

<p>å»äº†Hï¼Œç„¶åsort -nï¼Œå†å»æ•°å­—</p>

<p>åº”è¯¥åœ¨generateçš„æ—¶å€™åŒæ—¶ç®—bleuï¼Œä¸è¦åæ¥ç®—</p>

<p>ç®—BLUEåˆ†å­—è¿˜æ˜¯åˆ†è¯ï¼Ÿ</p>

<h2 id="æ–¹æ¡ˆ">æ–¹æ¡ˆ</h2>

<p>back-translation</p>

<p>model fusion + LM</p>

<p>å¤šæ¨¡å‹èåˆ</p>

<h2 id="æµ‹è¯•é˜¶æ®µ">æµ‹è¯•é˜¶æ®µ</h2>

<p>ç¬¬ä¸€æ­¥ï¼Œå¤„ç†å¥½test<strong>åŒè¯­</strong>æ•°æ®ï¼ŒåŒ…æ‹¬åˆ†è¯ï¼Œæ”¾åˆ°fairseqæ–‡ä»¶å¤¹ä¸‹ mainã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="mi">0</span> <span class="n">fairseq</span><span class="o">-</span><span class="n">train</span> <span class="n">data</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">yzp</span><span class="o">-</span><span class="mi">2</span> \
  <span class="o">-</span><span class="n">a</span> <span class="n">transformer</span> <span class="o">--</span><span class="n">optimizer</span> <span class="n">adam</span> <span class="o">--</span><span class="n">lr</span> <span class="mf">0.0005</span> <span class="o">-</span><span class="n">s</span> <span class="n">zh</span> <span class="o">-</span><span class="n">t</span> <span class="n">en</span> \
  <span class="o">--</span><span class="n">label</span><span class="o">-</span><span class="n">smoothing</span> <span class="mf">0.1</span> <span class="o">--</span><span class="n">dropout</span> <span class="mf">0.3</span> <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">tokens</span> <span class="mi">4000</span> \
  <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">lr</span> <span class="s">'1e-09'</span> <span class="o">--</span><span class="n">lr</span><span class="o">-</span><span class="n">scheduler</span> <span class="n">inverse_sqrt</span> <span class="o">--</span><span class="n">weight</span><span class="o">-</span><span class="n">decay</span> <span class="mf">0.0001</span> \
  <span class="o">--</span><span class="n">criterion</span> <span class="n">label_smoothed_cross_entropy</span> \
  <span class="o">--</span><span class="n">warmup</span><span class="o">-</span><span class="n">updates</span> <span class="mi">4000</span> <span class="o">--</span><span class="n">warmup</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lr</span> <span class="s">'1e-07'</span> \
  <span class="o">--</span><span class="n">adam</span><span class="o">-</span><span class="n">betas</span> <span class="s">'(0.9, 0.98)'</span> <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="nb">dir</span> <span class="n">checkpoints</span><span class="o">/</span><span class="n">yzp</span><span class="o">-</span><span class="mi">2</span>
</code></pre></div></div>

:ET